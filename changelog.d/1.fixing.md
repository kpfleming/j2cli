Resolved crash when writing final output. Increased test coverage to avoid regressions.
